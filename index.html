<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èˆ¬åˆ‘æ¡ˆç‹€æ³åˆ†æ - è‡ªå‹•ç°¡å ±ç”¢ç”Ÿå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/libs/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Microsoft JhengHei'; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .upload-group { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; flex-wrap: wrap; }
        .upload-group label { width: 100px; font-weight: bold; color: #495057; }
        input[type="file"] { flex: 1; min-width: 200px; }
        .btn-group { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        button { flex: 1; padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; color: white; min-width: 150px; }
        .btn-ppt { background-color: #007bff; }
        .btn-ppt:hover { background-color: #0056b3; }
        .btn-pdf { background-color: #dc3545; }
        .btn-pdf:hover { background-color: #c82333; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; color: #d9534f; line-height: 1.5; }
        
        /* éš±è—ç”¨æ–¼ç”¢å‡º PDF çš„æ’ç‰ˆå€å¡Š */
        #pdf-export-container { position: absolute; left: -9999px; top: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š å…¨èˆ¬åˆ‘æ¡ˆè‡ªå‹•ç°¡å ±ç”¢ç”Ÿå™¨<br><span style="font-size: 14px; color: #28a745;">(æ”¯æ´ CSVã€XLSã€XLSX æ ¼å¼)</span></h2>
    <p style="text-align:center; color:#666; margin-bottom: 25px; font-size: 14px;">æœ¬å·¥å…·ç‚ºå®Œå…¨é›¢ç·šé‹ç®—ï¼Œè³‡æ–™ä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ï¼Œæ‰‹æ©Ÿèˆ‡é›»è…¦çš†å¯å®‰å¿ƒä½¿ç”¨ã€‚</p>

    <div class="upload-group"><label>ä¸Šä¸Šé€±ï¼š</label><input type="file" id="file_ä¸Šä¸Šé€±" accept=".csv, .xls, .xlsx"></div>
    <div class="upload-group"><label>ä¸Šé€±ï¼š</label><input type="file" id="file_ä¸Šé€±" accept=".csv, .xls, .xlsx"></div>
    <div class="upload-group"><label>æœ¬é€±ï¼š</label><input type="file" id="file_æœ¬é€±" accept=".csv, .xls, .xlsx"></div>
    <div class="upload-group"><label>å»å¹´åŒæœŸï¼š</label><input type="file" id="file_å»å¹´åŒæœŸ" accept=".csv, .xls, .xlsx"></div>
    <div class="upload-group"><label>ä»Šå¹´ç´¯è¨ˆï¼š</label><input type="file" id="file_ä»Šå¹´ç´¯è¨ˆ" accept=".csv, .xls, .xlsx"></div>

    <div class="btn-group">
        <button class="btn-ppt" onclick="generateReport('pptx')">ğŸš€ ç”¢å‡ºç°¡å ±æª” (.pptx)</button>
        <button class="btn-pdf" onclick="generateReport('pdf')">ğŸ“„ ç”¢å‡º PDF æª” (.pdf)</button>
    </div>
    
    <div id="status"></div>
</div>

<div id="pdf-export-container"></div>

<script>
    const precinctOrder = ['æ¿æ©‹', 'æµ·å±±', 'ä¸‰é‡', 'æ–°èŠ', 'æ–°åº—', 'ä¸­å’Œ', 'æ°¸å’Œ', 'è˜†æ´²', 'åœŸåŸ', 'æ¨¹æ—', 'ä¸‰å³½', 'æ·¡æ°´', 'æ±æ­¢', 'æ—å£', 'ç‘èŠ³', 'é‡‘å±±'];
    const periods = ["ä¸Šä¸Šé€±", "ä¸Šé€±", "æœ¬é€±", "å»å¹´åŒæœŸ", "ä»Šå¹´ç´¯è¨ˆ"];
    let allData = {};

    function processDataArray(dataArray) {
        let processed = {};
        for(let i = 4; i < dataArray.length; i++) {
            let row = dataArray[i];
            if (!row || row.length < 4) continue;
            let name = row[0];
            if (!name || typeof name !== 'string') continue;
            name = name.replace('åˆ†å±€', '').trim();
            if (name === 'æ–°åŒ—å¸‚æ”¿åºœè­¦å¯Ÿå±€' || name === 'åˆè¨ˆ') continue;

            let occ = parseInt(row[1]) || 0;
            let clr = parseInt(row[3]) || 0;
            let rate = occ === 0 ? "0.00%" : ((clr / occ) * 100).toFixed(2) + "%";
            processed[name] = { occ: occ, clr: clr, rate: rate };
        }
        return processed;
    }

    function readFile(fileElement) {
        return new Promise((resolve, reject) => {
            let file = fileElement.files[0];
            if (!file) resolve(null);
            let fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                Papa.parse(file, {
                    encoding: "Big5", 
                    complete: function(results) { resolve(processDataArray(results.data)); },
                    error: function(err) { reject(new Error("CSV è®€å–å¤±æ•—ï¼š" + err.message)); }
                });
            } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data = new Uint8Array(e.target.result);
                        let workbook = XLSX.read(data, {type: 'array'});
                        let firstSheetName = workbook.SheetNames[0];
                        let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName], {header: 1, defval: ""});
                        resolve(processDataArray(jsonData));
                    } catch(err) { reject(new Error("Excel è§£æå¤±æ•—ã€‚")); }
                };
                reader.onerror = function() { reject(new Error("æª”æ¡ˆè®€å–å¤±æ•—ã€‚")); };
                reader.readAsArrayBuffer(file);
            } else { reject(new Error(`æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´ã€‚`)); }
        });
    }

    // ç”¢ç”Ÿåˆ†ææ–‡å­—çš„é‚è¼¯ (å…±ç”¨)
    function getAnalysisText() {
        let thisD = allData["æœ¬é€±"]["ä¸‰å³½"] || {occ:0, clr:0, rate:"0.00%"};
        let lastD = allData["ä¸Šé€±"]["ä¸‰å³½"] || {occ:0, clr:0, rate:"0.00%"};
        let twoAgoD = allData["ä¸Šä¸Šé€±"]["ä¸‰å³½"] || {occ:0, clr:0, rate:"0.00%"};
        let yearD = allData["ä»Šå¹´ç´¯è¨ˆ"]["ä¸‰å³½"] || {occ:0, clr:0, rate:"0.00%"};
        let lastYearD = allData["å»å¹´åŒæœŸ"]["ä¸‰å³½"] || {occ:0, clr:0, rate:"0.00%"};
        
        let diffLast = thisD.occ - lastD.occ;
        let diffTwoAgo = thisD.occ - twoAgoD.occ;
        let trendLast = diffLast > 0 ? `å¢åŠ  ${diffLast} ä»¶` : (diffLast < 0 ? `æ¸›å°‘ ${Math.abs(diffLast)} ä»¶` : "æŒå¹³");
        let trendTwoAgo = diffTwoAgo > 0 ? `å¢åŠ  ${diffTwoAgo} ä»¶` : (diffTwoAgo < 0 ? `æ¸›å°‘ ${Math.abs(diffTwoAgo)} ä»¶` : "æŒå¹³");

        let diffYear = yearD.occ - lastYearD.occ;
        let trendYear = diffYear > 0 ? `å¢åŠ  ${diffYear} ä»¶` : (diffYear < 0 ? `æ¸›å°‘ ${Math.abs(diffYear)} ä»¶` : "æŒå¹³");
        
        return `ã€ä¸‰å³½åˆ†å±€å…¨èˆ¬åˆ‘æ¡ˆç‹€æ³åˆ†æã€‘\n` +
               `1. è¿‘ä¸‰é€±ç™¼ç”Ÿæƒ…å½¢ï¼šæœ¬é€±ç™¼ç”Ÿ ${thisD.occ} ä»¶ (ç ´ç²ç‡ ${thisD.rate})ï¼Œä¸Šé€±ç™¼ç”Ÿ ${lastD.occ} ä»¶ï¼Œä¸Šä¸Šé€±ç™¼ç”Ÿ ${twoAgoD.occ} ä»¶ã€‚\n` +
               `   â–¶ æœ¬é€±è¼ƒä¸Šé€±${trendLast}ï¼Œè¼ƒä¸Šä¸Šé€±${trendTwoAgo}ã€‚\n` +
               `2. ç´¯è¨ˆç™¼ç”Ÿæƒ…å½¢ï¼šä»Šå¹´ç´¯è¨ˆç™¼ç”Ÿ ${yearD.occ.toLocaleString()} ä»¶ (æ•´é«”ç ´ç²ç‡ ${yearD.rate})ï¼Œå»å¹´åŒæœŸç™¼ç”Ÿ ${lastYearD.occ.toLocaleString()} ä»¶ã€‚\n` +
               `   â–¶ ä»Šå¹´è¼ƒå»å¹´åŒæœŸ${trendYear}ã€‚\n` +
               `3. å¾ŒçºŒå°‡æŒçºŒé‡å°å„é¡åˆ‘æ¡ˆç™¼ç”Ÿç†±é»ï¼Œè½å¯¦å·¡é‚å‹¤å‹™è¦åŠƒèˆ‡å„é …é˜²åˆ¶ä½œç‚ºã€‚`;
    }

    // è² è²¬ç”Ÿæˆ PDF ç‰ˆé¢çš„éš±è— HTML (é«˜ç•«è³ª 1920x1080 ç‰ˆæœ¬)
    function buildPDFLayout() {
        let analysisTextHTML = getAnalysisText().replace(/\n/g, "<br>");
        
        // å°‡å¯¬é«˜è¨­å®šç‚º 1920x1080ï¼Œä¸¦ä½¿ç”¨ flexbox è®“æ–‡å­—è‡ªç„¶å¾€ä¸‹æ’
        let html = `<div id="pdf-content-wrapper" style="width: 1920px; height: 1080px; background: #fff; padding: 60px 80px; box-sizing: border-box; display: flex; flex-direction: column; font-family: 'Microsoft JhengHei', sans-serif;">
            <h1 style="font-size: 46px; margin: 0 0 20px 0; font-weight: bold; color: #000;">å„åˆ†å±€å…¨èˆ¬åˆ‘æ¡ˆç™¼ç ´æ•¸</h1>
            <table style="width: 100%; border-collapse: collapse; font-size: 22px; text-align: center; border: 2px solid #666;">
                <tr>
                    <th colspan="2" style="background: #d9d9d9; border: 1px solid #999; padding: 8px;">åˆ†å±€åˆ¥</th>`;
        
        precinctOrder.forEach(p => {
            html += `<th style="background: #d9d9d9; border: 1px solid #999; padding: 8px; width: 5.3%;">${p}</th>`;
        });
        html += `</tr>`;

        periods.forEach(period => {
            let pData = allData[period];
            let pText = period.length === 4 ? period.substring(0,2) + "<br>" + period.substring(2) : period;

            // ç¬¬ä¸€åˆ—
            html += `<tr>
                <td rowspan="3" style="background: #f2f2f2; border: 1px solid #999; font-weight: bold; font-size: 24px;">${pText}</td>
                <td style="border: 1px solid #999; padding: 5px;">ç™¼ç”Ÿæ•¸</td>`;
            precinctOrder.forEach(p => {
                let d = pData[p] || {occ:0, clr:0, rate:"0.00%"};
                let occStr = period === "ä»Šå¹´ç´¯è¨ˆ" ? d.occ.toLocaleString() : d.occ.toString();
                html += `<td style="border: 1px solid #999; padding: 5px;">${occStr}</td>`;
            });
            html += `</tr>`;

            // ç¬¬äºŒåˆ—
            html += `<tr><td style="border: 1px solid #999; padding: 5px;">ç ´ç²æ•¸</td>`;
            precinctOrder.forEach(p => {
                let d = pData[p] || {occ:0, clr:0, rate:"0.00%"};
                let clrStr = period === "ä»Šå¹´ç´¯è¨ˆ" ? d.clr.toLocaleString() : d.clr.toString();
                html += `<td style="border: 1px solid #999; padding: 5px;">${clrStr}</td>`;
            });
            html += `</tr>`;

            // ç¬¬ä¸‰åˆ—
            html += `<tr><td style="border: 1px solid #999; padding: 5px;">ç ´ç²ç‡</td>`;
            precinctOrder.forEach(p => {
                let d = pData[p] || {occ:0, clr:0, rate:"0.00%"};
                html += `<td style="border: 1px solid #999; padding: 5px;">${d.rate}</td>`;
            });
            html += `</tr>`;
        });
        html += `</table>`;

        // åº•éƒ¨æ–‡å­—æ”¹ç‚ºä½¿ç”¨ margin-top æ¨é–‹é–“è·ï¼Œä¸å†çµ•å°å®šä½
        html += `<div style="margin-top: 35px; font-size: 28px; font-weight: bold; line-height: 1.5; text-align: left; color: #222;">${analysisTextHTML}</div>`;
        html += `</div>`;

        document.getElementById('pdf-export-container').innerHTML = html;
    }

    async function generateReport(format) {
        document.getElementById('status').innerText = "è™•ç†ä¸­ï¼Œè«‹ç¨å€™...";
        document.getElementById('status').style.color = "#f0ad4e";
        allData = {};

        try {
            for (let period of periods) {
                let el = document.getElementById("file_" + period);
                if (el.files.length === 0) throw new Error(`è«‹é¸æ“‡ã€${period}ã€‘çš„æª”æ¡ˆï¼`);
                allData[period] = await readFile(el);
            }

            if (format === 'pptx') {
                // =============== ç”¢å‡º PPTX ===============
                let pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_16x9'; 
                let slide = pptx.addSlide();

                slide.addText("å„åˆ†å±€å…¨èˆ¬åˆ‘æ¡ˆç™¼ç ´æ•¸", { x: 0.2, y: 0.1, w: 9.6, h: 0.4, fontSize: 20, bold: true });

                let tableRows = [];
                let headerRow = [{ text: "åˆ†å±€åˆ¥", options: { colspan: 2, align: "center", valign: "middle", bold: true, fill: "D9D9D9" } }];
                precinctOrder.forEach(p => { headerRow.push({ text: p, options: { align: "center", valign: "middle", bold: true, fill: "D9D9D9" } }); });
                tableRows.push(headerRow);

                periods.forEach(period => {
                    let pData = allData[period];
                    let periodText = period.length === 4 ? period.substring(0, 2) + "\n" + period.substring(2) : period;
                    let row1 = [{ text: periodText, options: { rowspan: 3, align: "center", valign: "middle", bold: true, fill: "F2F2F2" } }, { text: "ç™¼ç”Ÿæ•¸", options: { align: "center", valign: "middle", fill: "FAFAFA" } }];
                    let row2 = [{ text: "ç ´ç²æ•¸", options: { align: "center", valign: "middle", fill: "FAFAFA" } }];
                    let row3 = [{ text: "ç ´ç²ç‡", options: { align: "center", valign: "middle", fill: "FAFAFA" } }];

                    precinctOrder.forEach(p => {
                        let d = pData[p] || { occ: 0, clr: 0, rate: "0.00%" };
                        let occStr = period === "ä»Šå¹´ç´¯è¨ˆ" ? d.occ.toLocaleString() : d.occ.toString();
                        let clrStr = period === "ä»Šå¹´ç´¯è¨ˆ" ? d.clr.toLocaleString() : d.clr.toString();
                        row1.push({ text: occStr, options: { align: "center", valign: "middle" } });
                        row2.push({ text: clrStr, options: { align: "center", valign: "middle" } });
                        row3.push({ text: d.rate, options: { align: "center", valign: "middle" } });
                    });
                    tableRows.push(row1, row2, row3);
                });

                let colWidths = [0.65, 0.55]; 
                for(let i=0; i<16; i++) colWidths.push(0.52); 

                slide.addTable(tableRows, { x: 0.2, y: 0.55, w: 9.6, colW: colWidths, border: { type: "solid", pt: 1, color: "BFBFBF" }, fontSize: 9, margin: 2 });
                slide.addText(getAnalysisText(), { x: 0.2, y: 4.4, w: 9.6, h: 1.1, fontSize: 11.5, bold: true, valign: "top", color: "333333" });

                await pptx.writeFile({ fileName: "æœ¬é€±å…¨èˆ¬åˆ‘æ¡ˆç‹€æ³åˆ†æ.pptx" });
                document.getElementById('status').innerText = "âœ… PPTX ç°¡å ±ä¸‹è¼‰æˆåŠŸï¼";
                document.getElementById('status').style.color = "green";
                
            } else if (format === 'pdf') {
                // =============== ç”¢å‡º PDF ===============
                buildPDFLayout();
                let element = document.getElementById('pdf-content-wrapper');
                
                let opt = {
                  margin:       0,
                  filename:     'æœ¬é€±å…¨èˆ¬åˆ‘æ¡ˆç‹€æ³åˆ†æ.pdf',
                  image:        { type: 'jpeg', quality: 1 },
                  html2canvas:  { scale: 2 },
                  jsPDF:        { unit: 'px', format: [1920, 1080], orientation: 'landscape' } // ç•«å¸ƒå‡ç´šè‡³ 1920x1080
                };
                
                html2pdf().set(opt).from(element).save().then(() => {
                    document.getElementById('status').innerText = "âœ… PDF å ±è¡¨ä¸‹è¼‰æˆåŠŸï¼";
                    document.getElementById('status').style.color = "green";
                });
            }

        } catch (error) {
            console.error(error);
            document.getElementById('status').innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message;
            document.getElementById('status').style.color = "red";
        }
    }
</script>

</body>
</html>
